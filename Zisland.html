<!DOCTYPE html>
<html>
	<head>	
		<title>Z island</title>
		<style>button 	{height:40px; width:40px; background-color:white; border:2px solid black}</style>
	</head>
	<body onload="DrawHead(); drawShape();">
		<br><br><br><br><div style="width: 500px; margin: auto; border: 1px solid black;">
		<a href='#' onclick='location.reload(true); return false;'>
		<canvas id="canvas1" width="500px" height="50px"  style="display:block; margin-left:auto; margin-right:auto;" ></canvas></a>
		<canvas id="canvas2" width="500px" height="300px" style="display:block; margin-left:auto; margin-right:auto;" ></canvas><br>
		<table align="center"><tr><td>
			<table>
				<tr>
					<td></td>
					<td><button onmouseover="AU=1" onmouseout="AU=0; cpt=0;">^</button></td>
					<td></td>
				</tr>
				<tr>
					<td><button onmouseover="AL=1" onmouseout="AL=0; cpt=0;"><</button></td>
					<td></td>
					<td><button onmouseover="AR=1" onmouseout="AR=0; cpt=0;">></button></td>
				</tr>
				<tr>
					<td></td>
					<td><button onmouseover="AD=1" onmouseout="AD=0; cpt=0;">v</button></td>
					<td></td>
				</tr>
			</table>
		</td>
		<td>&emsp; &emsp; &emsp; &emsp; &emsp; &emsp;</td>
		<td>
			Zombies: <select autocomplete="off" id="NBZ"><option>3</option> <option>4</option> <option>5</option> <option>6</option> </select><br>
			Character's speed: <select autocomplete="off" id="CHS"><option>1</option> <option selected>2</option> <option>3</option> </select>
		</td>
		</tr></table><br><br></div>
	</body> 

	<script>
		var d=0;									// Is the player dead? (Game Over overlay trigger)
		var TheX=0;									// Position of the current field of view on the overall map from left (0) to right (2)
		var TheY=0;									// Position of the current field of view on the overall map from top (0) to bottom (2)
		var StX=[];									// Array to store X coordinates of shelter structures	
		var StY=[];  								// Array to store Y coordinates of shelter structures	
		var Lx=[];									// Lenght of structures on horizontal axis
		var Ly=[];									// Lenght of structures on vertical axis
		var Switch=1;								// Did we just change the field of view?
		var ZOM=3;									// Number of zombies
		var AU=0;									// Is the mouse over the "up" button or the "up" key active? 
		var AD=0; 									// Is the mouse over the "down" button or the "down" key active? 
		var AL=0; 									// Is the mouse over the "left" button or the "left" key active? 
		var AR=0;									// Is the mouse over the "right" button or the "right" key active? 
		var cpt=0;									// Counter to slow down repeated action of buttons (time buffer)

		addEventListener("keydown", (key) => {		// Key press events
			if(key.keyCode == 37 ){AL=1;}			// Left
			if(key.keyCode == 38 ){AU=1;}			// Up
			if(key.keyCode == 39 ){AR=1;}			// Right
			if(key.keyCode == 40 ){AD=1;}			// Down
		});
		
		addEventListener("keyup", (key) => {		// Key release events
			if(key.keyCode == 37 ){AL=0;}			// End of left
			if(key.keyCode == 38 ){AU=0;}			// End of up
			if(key.keyCode == 39 ){AR=0;}			// End of right
			if(key.keyCode == 40 ){AD=0;}			// End of down
		});
			
		document.getElementById('NBZ').addEventListener("change", (e) => {ZOM=e.target.value;});																					// Update number of zombies on user selection
		document.getElementById('CHS').addEventListener("change", (e) => {Vits[0]=e.target.value; AU=0; AD=0; AL=0; AR=0; cpt=0;});													// Update character's speed on user selection
		document.getElementById('NBZ').addEventListener('keydown', function(e) {if(e.which === 37 || e.which === 38 || e.which === 39 || e.which === 40) {e.preventDefault();}});	// Prevent arrow keys from changing number of zombies
		document.getElementById('CHS').addEventListener('keydown', function(e) {if(e.which === 37 || e.which === 38 || e.which === 39 || e.which === 40) {e.preventDefault();}});	// Prevent arrow keys from changing character's speed

		const minX=10;																					// Lower limit for zombies movements on the X axis
		const maxX=490;																					// Upper limit for zombies movements on the X axis
		const minY=10;																					// Lower limit for zombies movements on the Y axis
		const maxY=290;																					// Upper limit for zombies movements on the Y axis

		var PosX=[];	var PosY=[];	var DirX=[];	var DirY=[];	var Vits=[];					// Character (0) and Zombies (1 to 6) positions
		PosX[0]=60;		PosY[0]=60;		DirX[0]=0;		DirY[0]=0;		Vits[0]=2;						// Character position data
		for(j=1;j<7;j++){PosX[j]=200; PosY[j]=200; DirX[j]=1; DirY[j]=1; Vits[j]=1;}					// Zombies position data

		function Rectangle(c,x,y,l,h)		{c.fillRect (x,y,l,h);}
		function Clean(c) 					{c.fillStyle = "white";	c.fillRect (0, 0, 500, 300);}
		function GreenSetup(c) 				{c.fillStyle = "ForestGreen";	c.fillRect (0, 0, 500, 300);}
		function BlueSetup(c) 				{c.fillStyle = "LightSkyBlue";	c.fillRect (0, 0, 500, 300);}
		function YellowSetup(c) 			{c.fillStyle = "Moccasin";		c.fillRect (0, 0, 500, 300);}
		function Cercle(c,x,y,r) 			{c.beginPath();	c.arc(x, y, r, 0, Math.PI*2, true);	c.closePath(); c.fill();}
		function Trait(c,x1,y1,x2,y2,col) 	{c.beginPath(); c.moveTo(x1,y1);	c.lineTo(x2,y2);  c.strokeStyle = col;	c.stroke();}	
		function DontFuckingTouchMe()		{d=0; for(i=1;i<=ZOM;i++){if(Dist(i,0)<20){d=1;}}}																// Check distance with each zombie to know if player dies
		function Dist(a,b)					{return Dista=Math.round(Math.sqrt((PosX[a]-PosX[b])*(PosX[a]-PosX[b])+(PosY[a]-PosY[b])*(PosY[a]-PosY[b])));}	// Math function to compute distance between two points
		function up()						{if(CheckColor(PosX[0],PosY[0]-13)!=765){PosY[0]-=2;}}
		function down()						{if(CheckColor(PosX[0],PosY[0]+7)!=765) {PosY[0]+=2;}}
		function left()						{if(CheckColor(PosX[0]-10,PosY[0])!=765){PosX[0]-=2;}}
		function right()					{if(CheckColor(PosX[0]+10,PosY[0])!=765){PosX[0]+=2;}}
		function ReloadZombies()			{for(n=1;n<=ZOM;n++){PosX[n]=200; PosY[n]=200;}}
		
		function CheckColor(x,y){  
			var imgd = ctx2.getImageData(x, y, 1, 1);
			var pix = imgd.data;
			   pix[0] = 255 - pix[0]; // red
			   pix[1] = 255 - pix[1]; // green
			   pix[2] = 255 - pix[2]; // blue
			   return total=pix[0]+pix[1]+pix[2];
		}
		
		function Structures(){ 																			// Generate random shelter structures locations
			for(n=1;n<4;n++){																			// Number of structures, is 3
				if(Math.random()>0.5){LorL=1;} else{LorL=0;}											// Random determination of structure orientation (vertical or horizontal)
				StX[n]=Math.round(Math.random()*400+50);												// Random determination of structure starting point (X axis)
				StY[n]=Math.round(Math.random()*200+50);												// Random determination of structure starting point (Y axis)
				if(LorL==1){Lx[n]=50;}  else{Lx[n]=5;}													// If structure is horizontal, lenght on X is 50, else it is 5
				if(LorL==0){Ly[n]=50;}  else{Ly[n]=5;}													// If structure is vertical, lenght on Y is 50, else it is 5
			}
		}
		
		function BuildStructures(){																		// Build shelter structures		
			ctx2.fillStyle ="black"; Rectangle(ctx2,StX[1],StY[1],Lx[1],Ly[1]);							// Draw first shelter structure
			ctx2.fillStyle ="black"; Rectangle(ctx2,StX[2],StY[2],Lx[2],Ly[2]);							// Draw second shelter structure
			ctx2.fillStyle ="black"; Rectangle(ctx2,StX[3],StY[3],Lx[3],Ly[3]);							// Draw third shelter structure
		}

		function DrawC(C,X,Y){																			// Draw main character
			C.fillStyle ="black";   Cercle(C,X,Y-7.5,5);												// Head
			C.lineWidth = 2;																			// Limbs thickness
			Trait(C,X,Y-5,X+10,Y+5,"black");															// Right arm
			Trait(C,X,Y-5,X-10,Y+5,"black");															// left arm
			Trait(C,X,Y+5,X+5,Y+10,"black");															// Right leg
			Trait(C,X,Y+5,X-5,Y+10,"black");															// Left leg
			C.lineWidth = 4; Trait(C,X,Y-5,X,Y+5,"black");												// Torso
		}

		function DrawZ(C,X,Y,f){																		// Draw zombie
			C.fillStyle ="red";   Cercle(C,X-(4*f),Y-7.5,4);											// Head
			C.lineWidth =2;																				// Limbs thickness
			Trait(C,X-(4*f),Y-5,X+(10*f),Y-3,"red");													// Top arm
			Trait(C,X-(4*f),Y-1,X+(10*f),Y+1,"red");													// Bottom arm
			Trait(C,X-(4*f),Y+3,X-(6*f),Y+10,"red");													// Back leg
			Trait(C,X-(4*f),Y+3,X+0,Y+10,"red");														// Front leg
			C.lineWidth = 4; Trait(C,X-(4*f),Y-5,X-(4*f),Y+3,"red");									// Torso
		}

		function DrawHead(){																			// Draw header banner
			ctx1 = document.getElementById('canvas1').getContext('2d');									// Select canvas
			ctx1.fillStyle ="dimgray";  Rectangle(ctx1,0,0,500,50);										// Draw dark grey background
			ctx1.fillStyle ="orange";																	// Writing color
			ctx1.font="1.8em Helvetica";																// Font size
			ctx1.fillText("Z island by Dr.JW (v0.97)",10,35);											// Header banner text with version number
			DrawC(ctx1,400,30);																			// Draw decorative character
			DrawZ(ctx1,450,30,-1);																		// Draw decorative zombie
		}

		function drawShape(){  
			ctx2 = document.getElementById('canvas2').getContext('2d');									// Select canvas 
			Clean(ctx2);																				// Clear canvas

			if(TheY==0){																				// If field of view is at the top
				YellowSetup(ctx2);																		// Make background yellow
				ctx2.fillStyle ="black"; Rectangle(ctx2,0,0,500,20);									// Draw the top wall
			}

			if(TheY==1){GreenSetup(ctx2);}																// If field of view is in the middle, make background green

			if(TheY==2){																				// If field of view is at the bottom
				BlueSetup(ctx2);																		// Make background blue
				ctx2.fillStyle ="black"; Rectangle(ctx2,0,280,500,20);									// Draw the bottom wall
			}

			if(TheX==0){ctx2.fillStyle ="black"; Rectangle(ctx2,0,0,20,300);}							// If field of view is on the left, draw left wall
			if(TheX==2){ctx2.fillStyle ="black"; Rectangle(ctx2,480,0,20,300);}							// If field of view is on the right, draw right wall

			if(Switch==1){Structures(); Switch=0;}	BuildStructures();									// Call function to build shelter structures, and generate new ones if new field of view 

			if(PosX[0]>480){PosX[0]=30;  TheX++;	ReloadZombies();	Switch=1;}						// If player goes off-screen to the right, switch field of view, reload zombies, request new shelter structures
			if(PosY[0]>280){PosY[0]=30;	 TheY++;	ReloadZombies();	Switch=1;}						// If player goes off-screen at the bottom, switch field of view, reload zombies, request new shelter structures
			if(PosX[0]<20) {PosX[0]=470; TheX--;	ReloadZombies();	Switch=1;}						// If player goes off-screen to the left, switch field of view, reload zombies, request new shelter structures
			if(PosY[0]<20) {PosY[0]=270; TheY--;	ReloadZombies();	Switch=1;}						// If player goes off-screen at the top, switch field of view, reload zombies, request new shelter structures

			DrawC(ctx2,PosX[0],PosY[0]);																// Call to draw character
			if(AU==1){if(cpt==0){up();} 		cpt++; if(cpt>=4-Vits[0]){cpt=0;}}						// If button or key is active, go up
			else if(AD==1){if(cpt==0){down();} 	cpt++; if(cpt>=4-Vits[0]){cpt=0;}}						// If button or key is active, go down
			else if(AL==1){if(cpt==0){left();} 	cpt++; if(cpt>=4-Vits[0]){cpt=0;}}						// If button or key is active, go left
			else if(AR==1){if(cpt==0){right();} cpt++; if(cpt>=4-Vits[0]){cpt=0;}}						// If button or key is active, go right

			for(i=1;i<=ZOM;i++){ 																		// For each zombie, movement management and drawing
				if(Math.random()>0.99){DirX[i]=DirX[i]*-1;}												// 1% chance that the zombie changes horizontal direction  
				if(Math.random()>0.99){DirY[i]=DirY[i]*-1;}												// 1% chance that the zombie changes vertical direction
				if(PosX[i]>maxX){DirX[i]=-1;} 	if(PosX[i]<minX){DirX[i]=1;} 							// If zombie reaches the right or left of the field of view, change horizontal direction
				if(PosY[i]>maxY){DirY[i]=-1;} 	if(PosY[i]<minY){DirY[i]=1;}							// If zombie reaches the top or bottom of the field of view, change vertical direction
				if(CheckColor(PosX[i]+DirX[i]+(DirX[i]*5),PosY[i])!=765){PosX[i]=PosX[i]+DirX[i];}		// Move horizontally, if there is no wall on the way   
				if(CheckColor(PosX[i],PosY[i]+DirY[i]+(DirY[i]*5))!=765){PosY[i]=PosY[i]+DirY[i];}		// Move vertically, if there is no wall on the way
				DrawZ(ctx2,PosX[i],PosY[i],DirX[i]);													// Call to draw zombie
			}

			DontFuckingTouchMe();																		// Call function to check if the player is touched by a zombie
			if(d==0) {requestAnimationFrame(drawShape);}												// If not dead, continue the animation
			else{ctx2.fillStyle="orange"; ctx2.font="5em Helvetica"; ctx2.fillText("GAME OVER",7,200);}	// If dead, display the "Game Over" overlay
		}

	</script>
</html>
